"use strict";var app=angular.module("urbinsight",["ngAnimate","ngAria","ngCookies","ngMessages","ngResource","ui.router","ngSanitize","ngTouch","ui.bootstrap","urbinsight.services"]);app.config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),a.state("app",{"abstract":!0,templateUrl:"views/app.html",data:{requireLogin:!1}}).state("app.main",{"abstract":!0,templateUrl:"views/main.html"}).state("app.main.homepage",{url:"/",controller:"MainCtrl",views:{landing:{templateUrl:"views/homepage/landing.html"},pilotProcess:{templateUrl:"views/homepage/pilotProcess.html",controller:"ProcessCtrl"},pilots:{templateUrl:"views/homepage/pilots.html",controller:"PilotsCtrl"},layerIntro:{templateUrl:"views/homepage/layerIntro.html"},contact:{templateUrl:"views/homepage/contact.html"}}}).state("app.about",{url:"/about",templateUrl:"views/about.html",controller:"AboutCtrl"}).state("app.signup",{url:"/signup",templateUrl:"views/signup.html",controller:"SignupCtrl"}).state("app.compass",{url:"/compass",templateUrl:"views/compass.html",controller:"CompassCtrl"}).state("app.city",{templateUrl:"views/cities/cityDefault.html",controller:"CitiesCtrl"}).state("app.city.pilot",{url:"/dashboard/:city_name",views:{mapModal:{templateUrl:"views/cities/mapmodal.html",controller:"MapModalCtrl"}}}).state("dashboard",{url:"/dashboard",templateUrl:"views/dashboard.html",controller:"DashboardCtrl"})}]),angular.module("urbinsight").controller("MainCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("urbinsight").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("urbinsight").controller("SignupCtrl",["$scope","$location","$http",function(a,b,c){var d,e;a.signup=e={},e.user=d={},e.submit=function(){if(!(d.username&&d.email&&d.password1&&d.password2))return window.alert("Please fill out all fields."),!1;if(d.password1!==d.password2)return window.alert("Your passwords must match."),!1;var a=c.post("/signup",d);a.success(function(a){b.path("/dashboard"),console.log(a)}),a.error(function(a){console.log("error"),console.log(a)})},a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("urbinsight").controller("DashboardCtrl",["$scope","$location","$stateParams",function(a,b,c){a.addMap=function(){var b=window.L;b.mapbox.accessToken="pk.eyJ1IjoidXJiaW5zaWdodCIsImEiOiJIbG1xUDBBIn0.o2RgJkl1-wCO7yyG7Khlzg",a.map=b.mapbox.map("dashboardMap","urbinsight.l906cd2j",{zoomControl:!0,minZoom:3}).setView([0,0],3)},a.addMap(),a.$stateParams=c}]),angular.module("urbinsight").controller("ProcessCtrl",["$scope",function(a){a.addMap=function(){var a=window.L;console.log(a.mapbox),a.mapbox.accessToken="pk.eyJ1IjoidXJiaW5zaWdodCIsImEiOiJIbG1xUDBBIn0.o2RgJkl1-wCO7yyG7Khlzg";var b=a.mapbox.map("pilotProcessMap","urbinsight.jh7lje5c",{zoomControl:!1}).setView([0,0],2);b.touchZoom.disable(),b.doubleClickZoom.disable(),b.scrollWheelZoom.disable()},a.addMap(),a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("urbinsight").controller("PilotsCtrl",["$scope",function(a){a.imgLoader=function(){window.$(document).ready(function(){window.$("#medellin").hover(function(){window.$(this).removeClass("darken")},function(){window.$(this).addClass("darken")}),window.$("#cairo").hover(function(){window.$(this).removeClass("darken")},function(){window.$(this).addClass("darken")}),window.$("#casablanca").hover(function(){window.$(this).removeClass("darken")},function(){window.$(this).addClass("darken")})})},a.imgLoader(),a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("urbinsight").controller("CitiesCtrl",["$scope","$location","$http","Cities",function(a,b,c,d){var e;a.L=e=window.L,e.mapbox.accessToken="pk.eyJ1IjoidXJiaW5zaWdodCIsImEiOiJIbG1xUDBBIn0.o2RgJkl1-wCO7yyG7Khlzg",a.gridLayers=[],a.gridControls=[];var f=b.path().split("/")[2];a.overlayAddCtrl=function(b){a.gridLayer=e.mapbox.gridLayer(b.layer._tilejson.id),a.map.addLayer(a.gridLayer),a.gridControl=e.mapbox.gridControl(a.gridLayer),a.map.addControl(a.gridControl)},a.overlayRmvCtrl=function(b){for(var c=0;c<a.gridLayers.length;c++)if(a.gridLayers[c]._tilejson.id===b.layer._tilejson.id){a.map.removeLayer(a.gridLayers[c]),a.map.removeControl(a.gridControls[c]),a.gridLayers.splice(c,1),a.gridControls.splice(c,1);break}},a.additonalLayers=function(b){var c=!0,d={};return angular.forEach(b,function(b,f){c?(d[f]=e.mapbox.tileLayer(b).addTo(a.map),a.gridLayer=e.mapbox.gridLayer(b),a.gridLayers.push(a.gridLayer),a.map.addLayer(a.gridLayer),a.gridControl=e.mapbox.gridControl(a.gridLayer),a.gridControls.push(a.gridControl),a.map.addControl(a.gridControl),c=!1):d[f]=e.mapbox.tileLayer(b)}),d},a.addLayerControl=function(b){e.control.layers({"Base Map":e.mapbox.tileLayer("urbinsight.1114602d").addTo(a.map),"Satellite Map":e.mapbox.tileLayer("urbinsight.l906cd2j"),"Toner Map":e.tileLayer("https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png",{attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://creativecommons.org/licenses/by-sa/3.0">CC BY SA</a>.'}),"Watercolor Map":e.tileLayer("https://stamen-tiles-{s}.a.ssl.fastly.net/watercolor/{z}/{x}/{y}.png",{attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://creativecommons.org/licenses/by-sa/3.0">CC BY SA</a>.'})},b).addTo(a.map)},a.renderMap=function(b){a.city=b,a.map=e.mapbox.map("cityMap",{zoomControl:!0,minZoom:3,drawControl:!0}).setView([b.lat,b.lon],12);var c=e.featureGroup().addTo(a.map);a.layerDefs=b.layerDefinitions,a.addLayerControl(a.additonalLayers(b.layers)),a.map.on("overlayadd",a.overlayAddCtrl),a.map.on("overlayremove",a.overlayRmvCtrl);new e.Control.Draw({edit:{featureGroup:c}}).addTo(a.map);a.map.on("draw:created",function(a){c.addLayer(a.layer)})},a.linesAdded=[],a.drawFlows=function(b){var d=c.get("/data/relation/"+b.id),f=a;d.success(function(a,b){angular.forEach(f.linesAdded,function(a){f.map.removeLayer(a)}),angular.forEach(a,function(a){f.linesAdded.push(e.polyline(a,{color:"teal",opacity:1,weight:10}).addTo(f.map))})}),d.error(function(a,b){})},a.renderNodes=function(b){angular.forEach(b,function(b,c){var f=new e.MarkerClusterGroup({iconCreateFunction:function(a){return e.mapbox.marker.icon({"marker-symbol":a.getChildCount(),"marker-color":d.allColors()[c]})}});angular.forEach(b,function(b){var e=parseFloat(b.lat),g=parseFloat(b.lng),h=a.L.marker([e,g],{icon:a.L.mapbox.marker.icon({"marker-size":"small","marker-color":d.allColors()[c]})}).bindPopup("<p>Type: "+c+"</p><p>Id: "+b.id+"</p>").on("click",function(){a.drawFlows(b)});f.addLayer(h),a.markers=f}),a.map.addLayer(f)})},d.fetchCity(f,a.renderMap),d.getNodes(f,a.renderNodes)}]),angular.module("urbinsight").controller("CompassCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("urbinsight").controller("MapModalCtrl",["$scope",function(a){a.renderLine=function(a){var b={top:20,right:80,bottom:30,left:50},c=430-b.left-b.right,d=250-b.top-b.bottom,e=d3.time.format("%Y%m%d").parse,f=d3.time.scale().range([0,c]),g=d3.scale.linear().range([d,0]),h=d3.scale.category10(),i=d3.svg.axis().scale(f).orient("bottom"),j=d3.svg.axis().scale(g).orient("left"),k=d3.svg.line().interpolate("basis").x(function(a){return f(a.date)}).y(function(a){return g(a.temperature)}),l=d3.select("#line").append("svg").attr("width",c+b.left+b.right).attr("height",d+b.top+b.bottom).append("g").attr("transform","translate("+b.left+","+b.top+")");h.domain(d3.keys(a[0]).filter(function(a){return"date"!==a})),a.forEach(function(a){a.date=e(a.date)});var m=h.domain().map(function(b){return{name:b,values:a.map(function(a){return{date:a.date,temperature:+a[b]}})}});f.domain(d3.extent(a,function(a){return a.date})),g.domain([d3.min(m,function(a){return d3.min(a.values,function(a){return a.temperature})}),d3.max(m,function(a){return d3.max(a.values,function(a){return a.temperature})})]),l.append("g").attr("class","x axis").attr("transform","translate(0,"+d+")").call(i),l.append("g").attr("class","y axis").call(j).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Temperature (ÂºF)");var n=l.selectAll(".city").data(m).enter().append("g").attr("class","city");n.append("path").attr("class","line").attr("d",function(a){return k(a.values)}).style("stroke",function(a){return h(a.name)}),n.append("text").datum(function(a){return{name:a.name,value:a.values[a.values.length-1]}}).attr("transform",function(a){return"translate("+f(a.value.date)+","+g(a.value.temperature)+")"}).attr("x",3).attr("dy",".35em").text(function(a){return a.name})},a.render=function(a){var b=function(a){a.x0=a.x,a.dx0=a.dx},c=function(a){var b=d3.interpolate({x:a.x0,dx:a.dx0},a);return function(c){var d=b(c);return a.x0=d.x,a.dx0=d.dx,j(d)}},d=200,e=200,f=Math.min(d,e)/2,g=d3.scale.category10(),h=d3.select("#viz").append("svg").attr("width",d).attr("height",e).append("g").attr("transform","translate("+d/2+","+.52*e+")"),i=d3.layout.partition().sort(null).size([2*Math.PI,f*f]).value(function(a){return 1}),j=d3.svg.arc().startAngle(function(a){return a.x}).endAngle(function(a){return a.x+a.dx}).innerRadius(function(a){return Math.sqrt(a.y)}).outerRadius(function(a){return Math.sqrt(a.y+a.dy)}),k=h.datum(a).selectAll("path").data(i.nodes).enter().append("path").attr("display",function(a){return a.depth?null:"none"}).attr("d",j).style("stroke","#fff").style("fill",function(a){return g((a.children?a:a.parent).name)}).style("fill-rule","evenodd").each(b);d3.selectAll("input").on("change",function(){var a="count"===this.value?function(){return 1}:function(a){return a.size};k.data(i.value(a).nodes).transition().duration(1500).attrTween("d",c)}),d3.select(self.frameElement).style("height",e+"px")},a.fetchPieData=function(){d3.json("https://gist.githubusercontent.com/shkfnly/2da4667e9f654be9dfd0/raw/1e5746ae751bff323a8831a105f25fec3577b9fa/testdata.json",function(b,c){a.data=c,a.render(c)})},a.fetchLineData=function(){d3.tsv("https://gist.githubusercontent.com/shkfnly/9ad173c4c972024521ec/raw/c4e8fc0369683d2706eebcaa28c75ff1a9206883/testdata.tsv",function(b,c){a.data=c,a.renderLine(c)})},a.fetchLineData(),a.fetchPieData(),$("#plusclick").on("click",function(a){$("#plusclick").toggleClass("opened"),$("#mapModal").toggleClass("hoveredon"),$("#modalbar").toggleClass("shown")})}]),angular.module("urbinsight.services",[]).factory("Cities",["$http",function(a){var b={source:"#9c89cc",upstream:"#7ec9b1",demand:"#3ca0d3",downstream:"#fa946e",sink:"#f1f075"},c=window.L;return c.mapbox.accessToken="pk.eyJ1IjoidXJiaW5zaWdodCIsImEiOiJIbG1xUDBBIn0.o2RgJkl1-wCO7yyG7Khlzg",{fetchCity:function(b,c){var d=a.get("/data/city/"+b);d.success(function(a,b){return c(a)})},createCity:function(b){var c=a.post("/data/city/"+b);c.success(function(a,b){console.log("createcity ran in service")})},getNodes:function(b,c){var d=a.get("/data/label/"+b);d.success(function(a,b){return c(a)})},allColors:function(){return b}}}]);